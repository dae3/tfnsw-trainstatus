'use strict';

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

require('dotenv').config();

const request = require('request-promise-native');

const gtfs = require('./gtfs.js');

const {
  print,
  stringify
} = require('q-i');

const aws = require('aws-sdk');

exports.handler = async function (event, context) {
  var response = [];
  filtered_alerts().subscribe(response.push, () => {
    return new Promise((resolve, reject) => {
      resolve(null, {
        'body': response
      });
    });
  });
};

const filtered_alerts = function (schema) {
  const alerts = (0, _rxjs.from)(gtfs.getTrainsStatus()).pipe((0, _operators.map)(raw => gtfs.parseGTFS(raw.body)), (0, _operators.map)(cooked => schema.FeedMessage.read(cooked).entity), (0, _operators.mergeAll)()); //alerts.pipe(count()).subscribe(num => console.log(`${num} total alerts`));

  const f_alerts = (0, _rxjs.merge)(alerts.pipe((0, _operators.filter)(stop_filter('278210'))), alerts.pipe((0, _operators.filter)(stop_filter('2782181'))), alerts.pipe((0, _operators.filter)(stop_filter('2782182'))), alerts.pipe((0, _operators.filter)(stop_filter('200060'))), alerts.pipe((0, _operators.filter)(stop_filter('206520'))), alerts.pipe((0, _operators.filter)(route_filter('BMT_1'))), alerts.pipe((0, _operators.filter)(route_filter('BMT_2'))), alerts.pipe((0, _operators.filter)(route_filter('WST_1a'))), alerts.pipe((0, _operators.filter)(route_filter('WST_1b'))), alerts.pipe((0, _operators.filter)(route_filter('WST_2c'))), alerts.pipe((0, _operators.filter)(route_filter('WST_2d'))), alerts.pipe((0, _operators.filter)(trip_filter('W512'))), alerts.pipe((0, _operators.filter)(trip_filter('W579'))));
  return alerts;
};

gtfs.getGTFSSchema().then(schema => {
  // filtered_alerts(schema).pipe(map(entity=>entity.alert.header_text.translation[0].text)).subscribe(print);
  filtered_alerts(schema).pipe((0, _operators.map)(alert_formatter), (0, _operators.mergeAll)()).subscribe(print);
}); // returns an Observable which emits an alert formatted as an object

function alert_formatter(entity) {
  return (0, _rxjs.from)(new Promise(function (resolve, reject) {
    try {
      print(entity.alert.informed_entity);
      var entities = entity.alert.informed_entity.map(gtfs.getEntityName);
      Promise.all(entities).then(ea => {
        resolve({
          'title': entity.alert.header_text.translation[0].text + ' (' + ea.filter((e, i, a) => i == 0 ? true : !a.slice(0, i).includes(e)).reduce((a, v, i) => a + (i > 0 ? ', ' : '') + v, '') + ')',
          'message': entity.alert.description_text.translation[0].text,
          'link': entity.alert.url.translation[0].text
        });
      });
    } catch (e) {
      reject(e);
    }
  }));
}

function entity_id(entity) {
  if (entity.trip) {
    return entity.trip;
  } else if (entity.stop_id != '') {
    return entity.stop_id;
  } else if (entity.route_id != '') {
    return entity.route_id;
  } else {
    return 'unknown';
  }
}

function stop_filter(id) {
  return entity => entity.alert.informed_entity.map(i => i.stop_id).includes(id);
}

function route_filter(id) {
  return entity => entity.alert.informed_entity.map(i => i.route_id).includes(id);
}

function trip_filter(id) {
  return entity => entity.alert.informed_entity.trip && entity.alert.informed_entity.map(i => i.trip.trip_id.slice(0, trip_id.indexOf('.') - 1)).includes(id);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9hcHAuanMiXSwibmFtZXMiOlsicmVxdWlyZSIsImNvbmZpZyIsInJlcXVlc3QiLCJndGZzIiwicHJpbnQiLCJzdHJpbmdpZnkiLCJhd3MiLCJleHBvcnRzIiwiaGFuZGxlciIsImV2ZW50IiwiY29udGV4dCIsInJlc3BvbnNlIiwiZmlsdGVyZWRfYWxlcnRzIiwic3Vic2NyaWJlIiwicHVzaCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2NoZW1hIiwiYWxlcnRzIiwiZ2V0VHJhaW5zU3RhdHVzIiwicGlwZSIsInJhdyIsInBhcnNlR1RGUyIsImJvZHkiLCJjb29rZWQiLCJGZWVkTWVzc2FnZSIsInJlYWQiLCJlbnRpdHkiLCJmX2FsZXJ0cyIsInN0b3BfZmlsdGVyIiwicm91dGVfZmlsdGVyIiwidHJpcF9maWx0ZXIiLCJnZXRHVEZTU2NoZW1hIiwidGhlbiIsImFsZXJ0X2Zvcm1hdHRlciIsImFsZXJ0IiwiaW5mb3JtZWRfZW50aXR5IiwiZW50aXRpZXMiLCJtYXAiLCJnZXRFbnRpdHlOYW1lIiwiYWxsIiwiZWEiLCJoZWFkZXJfdGV4dCIsInRyYW5zbGF0aW9uIiwidGV4dCIsImZpbHRlciIsImUiLCJpIiwiYSIsInNsaWNlIiwiaW5jbHVkZXMiLCJyZWR1Y2UiLCJ2IiwiZGVzY3JpcHRpb25fdGV4dCIsInVybCIsImVudGl0eV9pZCIsInRyaXAiLCJzdG9wX2lkIiwicm91dGVfaWQiLCJpZCIsInRyaXBfaWQiLCJpbmRleE9mIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFJQTs7QUFDQTs7QUFKQUEsT0FBTyxDQUFDLFFBQUQsQ0FBUCxDQUFrQkMsTUFBbEI7O0FBQ0EsTUFBTUMsT0FBTyxHQUFHRixPQUFPLENBQUMsd0JBQUQsQ0FBdkI7O0FBQ0EsTUFBTUcsSUFBSSxHQUFHSCxPQUFPLENBQUMsV0FBRCxDQUFwQjs7QUFHQSxNQUFNO0FBQUVJLEVBQUFBLEtBQUY7QUFBU0MsRUFBQUE7QUFBVCxJQUF1QkwsT0FBTyxDQUFDLEtBQUQs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Q0FBQyxDQUFDUyxJQUFGLENBQU9JLE9BQVAsQ0FBZVgsS0FBZixDQUFxQixDQUFyQixFQUF3QlcsT0FBTyxDQUFDQyxPQUFSLENBQWdCLEdBQWhCLElBQXFCLENBQTdDLENBQXBDLEVBQXFGWCxRQUFyRixDQUE4RlMsRUFBOUYsQ0FBeEQ7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxucmVxdWlyZSgnZG90ZW52JykuY29uZmlnKCk7XHJcbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0LXByb21pc2UtbmF0aXZlJyk7XHJcbmNvbnN0IGd0ZnMgPSByZXF1aXJlKCcuL2d0ZnMuanMnKTtcclxuaW1wb3J0IHsgbWVyZ2UsIGZyb20sIHRpbWVyIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGNvdW50LCBmbGF0TWFwLCBmaWx0ZXIsIGZpcnN0LCBtYXBUbywgbWFwLCB0YXAsIG1lcmdlQWxsLCByZWR1Y2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmNvbnN0IHsgcHJpbnQsIHN0cmluZ2lmeSB9ID0gcmVxdWlyZSgncS1pJyk7XHJcbmNvbnN0IGF3cyA9IHJlcXVpcmUoJ2F3cy1zZGsnKTtcclxuXHJcbmV4cG9ydHMuaGFuZGxlciA9IGFzeW5jIGZ1bmN0aW9uKGV2ZW50LCBjb250ZXh0KSB7XHJcbiAgdmFyIHJlc3BvbnNlID0gW107XHJcblxyXG4gIGZpbHRlcmVkX2FsZXJ0cygpLnN1YnNjcmliZShcclxuICAgIHJlc3BvbnNlLnB1c2gsXHJcbiAgICAoKSA9PiB7XHJcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgcmVzb2x2ZShudWxsLCB7ICdib2R5JyA6IHJlc3BvbnNlIH0pXHJcbiAgICAgIH0pXHJcbiAgICB9LFxyXG4gIClcclxufVxyXG5cclxuXHJcbmNvbnN0IGZpbHRlcmVkX2FsZXJ0cyA9IGZ1bmN0aW9uKHNjaGVtYSkge1xyXG4gIGNvbnN0IGFsZXJ0cyA9IFxyXG4gICAgZnJvbShndGZzLmdldFRyYWluc1N0YXR1cygpKS5waXBlKFxyXG4gICAgICBtYXAocmF3ID0+IGd0ZnMucGFyc2VHVEZTKHJhdy5ib2R5KSksXHJcbiAgICAgIG1hcChjb29rZWQgPT4gc2NoZW1hLkZlZWRNZXNzYWdlLnJlYWQoY29va2VkKS5lbnRpdHkpLFxyXG4gICAgICBtZXJnZUFsbCgpLFxyXG4gICAgKVxyXG5cclxuXHQvL2FsZXJ0cy5waXBlKGNvdW50KCkpLnN1YnNjcmliZShudW0gPT4gY29uc29sZS5sb2coYCR7bnVtfSB0b3RhbCBhbGVydHNgKSk7XHJcblxyXG4gIGNvbnN0IGZfYWxlcnRzID0gbWVyZ2UoXHJcbiAgICBhbGVydHMucGlwZSggZmlsdGVyKHN0b3BfZmlsdGVyKCcyNzgyMTAnKSApICksXHJcbiAgICBhbGVydHMucGlwZSggZmlsdGVyKHN0b3BfZmlsdGVyKCcyNzgyMTgxJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihzdG9wX2ZpbHRlcignMjc4MjE4MicpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIoc3RvcF9maWx0ZXIoJzIwMDA2MCcpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIoc3RvcF9maWx0ZXIoJzIwNjUyMCcpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIocm91dGVfZmlsdGVyKCdCTVRfMScpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIocm91dGVfZmlsdGVyKCdCTVRfMicpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIocm91dGVfZmlsdGVyKCdXU1RfMWEnKSApICksXHJcbiAgICBhbGVydHMucGlwZSggZmlsdGVyKHJvdXRlX2ZpbHRlcignV1NUXzFiJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihyb3V0ZV9maWx0ZXIoJ1dTVF8yYycpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIocm91dGVfZmlsdGVyKCdXU1RfMmQnKSApICksXHJcbiAgICBhbGVydHMucGlwZSggZmlsdGVyKHRyaXBfZmlsdGVyKCdXNTEyJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcih0cmlwX2ZpbHRlcignVzU3OScpICkgKVxyXG5cdCk7XHJcblxyXG5cdHJldHVybiBhbGVydHM7XHJcbn1cclxuXHJcbmd0ZnMuZ2V0R1RGU1NjaGVtYSgpLnRoZW4oc2NoZW1hID0+IHtcclxuXHQvLyBmaWx0ZXJlZF9hbGVydHMoc2NoZW1hKS5waXBlKG1hcChlbnRpdHk9PmVudGl0eS5hbGVydC5oZWFkZXJfdGV4dC50cmFuc2xhdGlvblswXS50ZXh0KSkuc3Vic2NyaWJlKHByaW50KTtcclxuXHRmaWx0ZXJlZF9hbGVydHMoc2NoZW1hKS5waXBlKG1hcChhbGVydF9mb3JtYXR0ZXIpLCBtZXJnZUFsbCgpKS5zdWJzY3JpYmUocHJpbnQpO1xyXG59KVxyXG5cclxuLy8gcmV0dXJucyBhbiBPYnNlcnZhYmxlIHdoaWNoIGVtaXRzIGFuIGFsZXJ0IGZvcm1hdHRlZCBhcyBhbiBvYmplY3RcclxuZnVuY3Rpb24gYWxlcnRfZm9ybWF0dGVyKGVudGl0eSkge1xyXG4gIHJldHVybiBmcm9tKG5ldyBQcm9taXNlKCBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgIHRyeVxyXG4gICAge1xyXG5cdFx0XHRwcmludChlbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5KTtcclxuICAgICAgdmFyIGVudGl0aWVzID0gZW50aXR5LmFsZXJ0LmluZm9ybWVkX2VudGl0eS5tYXAoZ3Rmcy5nZXRFbnRpdHlOYW1lKTtcclxuICAgICAgUHJvbWlzZS5hbGwoZW50aXRpZXMpLnRoZW4oZWEgPT4ge1xyXG4gICAgICAgIHJlc29sdmUoXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgICd0aXRsZScgOiBlbnRpdHkuYWxlcnQuaGVhZGVyX3RleHQudHJhbnNsYXRpb25bMF0udGV4dCArICcgKCcgK1xyXG4gICAgICAgICAgICBlYS5maWx0ZXIoKGUsaSxhKSA9PiBpID09IDAgPyB0cnVlIDogIWEuc2xpY2UoMCxpKS5pbmNsdWRlcyhlKSlcclxuICAgICAgICAgICAgLnJlZHVjZSgoYSx2LGkpPT5hKyhpPjA/JywgJzonJykrdiwgJycpICsgJyknICxcclxuICAgICAgICAgICAgJ21lc3NhZ2UnIDogZW50aXR5LmFsZXJ0LmRlc2NyaXB0aW9uX3RleHQudHJhbnNsYXRpb25bMF0udGV4dCxcclxuICAgICAgICAgICAgJ2xpbmsnICA6IGVudGl0eS5hbGVydC51cmwudHJhbnNsYXRpb25bMF0udGV4dFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIClcclxuICAgICAgfSlcclxuICAgIH0gY2F0Y2goZSkgeyByZWplY3QoZSkgfVxyXG4gIH0pXHJcbiAgKVxyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gZW50aXR5X2lkKGVudGl0eSkge1xyXG4gIGlmIChlbnRpdHkudHJpcCkge1xyXG4gICAgcmV0dXJuIGVudGl0eS50cmlwXHJcbiAgfSBlbHNlIGlmIChlbnRpdHkuc3RvcF9pZCAhPSAnJykge1xyXG4gICAgcmV0dXJuIGVudGl0eS5zdG9wX2lkXHJcbiAgfSBlbHNlIGlmIChlbnRpdHkucm91dGVfaWQgIT0gJycpIHtcclxuICAgIHJldHVybiBlbnRpdHkucm91dGVfaWRcclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuICd1bmtub3duJ1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gc3RvcF9maWx0ZXIoaWQpIHtcclxuICByZXR1cm4gKGVudGl0eSkgPT4gZW50aXR5LmFsZXJ0LmluZm9ybWVkX2VudGl0eS5tYXAoaT0+aS5zdG9wX2lkKS5pbmNsdWRlcyhpZClcclxufVxyXG5mdW5jdGlvbiByb3V0ZV9maWx0ZXIoaWQpIHtcclxuICByZXR1cm4gKGVudGl0eSkgPT4gZW50aXR5LmFsZXJ0LmluZm9ybWVkX2VudGl0eS5tYXAoaT0+aS5yb3V0ZV9pZCkuaW5jbHVkZXMoaWQpXHJcbn1cclxuZnVuY3Rpb24gdHJpcF9maWx0ZXIoaWQpIHtcclxuICByZXR1cm4gKGVudGl0eSkgPT4gZW50aXR5LmFsZXJ0LmluZm9ybWVkX2VudGl0eS50cmlwICYmIGVudGl0eS5hbGVydC5pbmZvcm1lZF9lbnRpdHkubWFwKGk9PmkudHJpcC50cmlwX2lkLnNsaWNlKDAsIHRyaXBfaWQuaW5kZXhPZignLicpLTEpKS5pbmNsdWRlcyhpZClcclxufVxyXG4iXX0=