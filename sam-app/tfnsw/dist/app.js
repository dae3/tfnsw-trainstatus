'use strict';

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

require('dotenv').config();

const request = require('request-promise-native');

const gtfs = require('./gtfs.js');

const {
  print,
  stringify
} = require('q-i');

const aws = require('aws-sdk');

exports.handler = async function (event, context) {
  var response = [];
  filtered_alerts().subscribe(response.push, () => {
    return new Promise((resolve, reject) => {
      resolve(null, {
        'body': response
      });
    });
  });
};

const filtered_alerts = function (schema) {
  const alerts = (0, _rxjs.from)(gtfs.getTrainsStatus()).pipe((0, _operators.map)(raw => gtfs.parseGTFS(raw.body)), (0, _operators.map)(cooked => schema.FeedMessage.read(cooked).entity), (0, _operators.mergeAll)());
  return (0, _rxjs.concat)(alerts.pipe((0, _operators.filter)(stop_filter('278210'))), alerts.pipe((0, _operators.filter)(stop_filter('2782181'))), alerts.pipe((0, _operators.filter)(stop_filter('2782182'))), alerts.pipe((0, _operators.filter)(stop_filter('200060'))), alerts.pipe((0, _operators.filter)(stop_filter('206520'))), alerts.pipe((0, _operators.filter)(route_filter('BMT_1'))), alerts.pipe((0, _operators.filter)(route_filter('BMT_2'))), alerts.pipe((0, _operators.filter)(route_filter('WST_1a'))), alerts.pipe((0, _operators.filter)(route_filter('WST_1b'))), alerts.pipe((0, _operators.filter)(route_filter('WST_2c'))), alerts.pipe((0, _operators.filter)(route_filter('WST_2d'))), alerts.pipe((0, _operators.filter)(trip_filter('W512'))), alerts.pipe((0, _operators.filter)(trip_filter('W579'))));
};

gtfs.getGTFSSchema().then(schema => {
  filtered_alerts(schema).subscribe(print); // filtered_alerts(schema).pipe(map(alert_formatter), mergeAll()).subscribe(print);
}); // returns an Observable which emits an alert formatted as an object

function alert_formatter(entity) {
  return (0, _rxjs.from)(new Promise(function (resolve, reject) {
    try {
      var entities = entity.alert.informed_entity.map(gtfs.getEntityName);
      Promise.all(entities).then(ea => {
        resolve({
          'title': entity.alert.header_text.translation[0].text + ' (' + ea.filter((e, i, a) => i == 0 ? true : !a.slice(0, i).includes(e)).reduce((a, v, i) => a + (i > 0 ? ', ' : '') + v, '') + ')',
          'message': entity.alert.description_text.translation[0].text,
          'link': entity.alert.url.translation[0].text
        });
      });
    } catch (e) {
      reject(e);
    }
  }));
}

function entity_id(entity) {
  if (entity.trip) {
    return entity.trip;
  } else if (entity.stop_id != '') {
    return entity.stop_id;
  } else if (entity.route_id != '') {
    return entity.route_id;
  } else {
    return 'unknown';
  }
}

function stop_filter(id) {
  return entity => entity.alert.informed_entity.map(i => i.stop_id).includes(id);
}

function route_filter(id) {
  return entity => entity.alert.informed_entity.map(i => i.route_id).includes(id);
}

function trip_filter(id) {
  return entity => entity.alert.informed_entity.trip && entity.alert.informed_entity.map(i => i.trip.trip_id.slice(0, trip_id.indexOf('.') - 1)).includes(id);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAuanMiXSwibmFtZXMiOlsicmVxdWlyZSIsImNvbmZpZyIsInJlcXVlc3QiLCJndGZzIiwicHJpbnQiLCJzdHJpbmdpZnkiLCJhd3MiLCJleHBvcnRzIiwiaGFuZGxlciIsImV2ZW50IiwiY29udGV4dCIsInJlc3BvbnNlIiwiZmlsdGVyZWRfYWxlcnRzIiwic3Vic2NyaWJlIiwicHVzaCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2NoZW1hIiwiYWxlcnRzIiwiZ2V0VHJhaW5zU3RhdHVzIiwicGlwZSIsInJhdyIsInBhcnNlR1RGUyIsImJvZHkiLCJjb29rZWQiLCJGZWVkTWVzc2FnZSIsInJlYWQiLCJlbnRpdHkiLCJzdG9wX2ZpbHRlciIsInJvdXRlX2ZpbHRlciIsInRyaXBfZmlsdGVyIiwiZ2V0R1RGU1NjaGVtYSIsInRoZW4iLCJhbGVydF9mb3JtYXR0ZXIiLCJlbnRpdGllcyIsImFsZXJ0IiwiaW5mb3JtZWRfZW50aXR5IiwibWFwIiwiZ2V0RW50aXR5TmFtZSIsImFsbCIsImVhIiwiaGVhZGVyX3RleHQiLCJ0cmFuc2xhdGlvbiIsInRleHQiLCJmaWx0ZXIiLCJlIiwiaSIsImEiLCJzbGljZSIsImluY2x1ZGVzIiwicmVkdWNlIiwidiIsImRlc2NyaXB0aW9uX3RleHQiLCJ1cmwiLCJlbnRpdHlfaWQiLCJ0cmlwIiwic3RvcF9pZCIsInJvdXRlX2lkIiwiaWQiLCJ0cmlwX2lkIiwiaW5kZXhPZiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBSUE7O0FBQ0E7O0FBSkFBLE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JDLE1BQWxCOztBQUNBLE1BQU1DLE9BQU8sR0FBR0YsT0FBTyxDQUFDLHdCQUFELENBQXZCOztBQUNBLE1BQU1HLElBQUksR0FBR0gsT0FBTyxDQUFDLFdBQUQsQ0FBcEI7O0FBR0EsTUFBTTtBQUFFSSxFQUFBQSxLQUFGO0FBQVNDLEVBQUFBO0FBQVQsSUFBdUJMLE9BQU8sQ0FBQyxLQUFELENBQXBDOztB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b250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxucmVxdWlyZSgnZG90ZW52JykuY29uZmlnKCk7XHJcbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0LXByb21pc2UtbmF0aXZlJyk7XHJcbmNvbnN0IGd0ZnMgPSByZXF1aXJlKCcuL2d0ZnMuanMnKTtcclxuaW1wb3J0IHsgY29uY2F0LCBtZXJnZSwgZnJvbSwgdGltZXIgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZmxhdE1hcCwgZmlsdGVyLCBmaXJzdCwgbWFwVG8sIG1hcCwgdGFwLCBtZXJnZUFsbCwgcmVkdWNlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5jb25zdCB7IHByaW50LCBzdHJpbmdpZnkgfSA9IHJlcXVpcmUoJ3EtaScpO1xyXG5jb25zdCBhd3MgPSByZXF1aXJlKCdhd3Mtc2RrJyk7XHJcblxyXG5leHBvcnRzLmhhbmRsZXIgPSBhc3luYyBmdW5jdGlvbihldmVudCwgY29udGV4dCkge1xyXG4gIHZhciByZXNwb25zZSA9IFtdO1xyXG5cclxuICBmaWx0ZXJlZF9hbGVydHMoKS5zdWJzY3JpYmUoXHJcbiAgICByZXNwb25zZS5wdXNoLFxyXG4gICAgKCkgPT4ge1xyXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIHJlc29sdmUobnVsbCwgeyAnYm9keScgOiByZXNwb25zZSB9KVxyXG4gICAgICB9KVxyXG4gICAgfSxcclxuICApXHJcbn1cclxuXHJcblxyXG5jb25zdCBmaWx0ZXJlZF9hbGVydHMgPSBmdW5jdGlvbihzY2hlbWEpIHtcclxuICBjb25zdCBhbGVydHMgPSBcclxuICAgIGZyb20oZ3Rmcy5nZXRUcmFpbnNTdGF0dXMoKSkucGlwZShcclxuICAgICAgbWFwKHJhdyA9PiBndGZzLnBhcnNlR1RGUyhyYXcuYm9keSkpLFxyXG4gICAgICBtYXAoY29va2VkID0+IHNjaGVtYS5GZWVkTWVzc2FnZS5yZWFkKGNvb2tlZCkuZW50aXR5KSxcclxuICAgICAgbWVyZ2VBbGwoKSxcclxuICAgIClcclxuXHJcbiAgcmV0dXJuIGNvbmNhdChcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIoc3RvcF9maWx0ZXIoJzI3ODIxMCcpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIoc3RvcF9maWx0ZXIoJzI3ODIxODEnKSApICksXHJcbiAgICBhbGVydHMucGlwZSggZmlsdGVyKHN0b3BfZmlsdGVyKCcyNzgyMTgyJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihzdG9wX2ZpbHRlcignMjAwMDYwJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihzdG9wX2ZpbHRlcignMjA2NTIwJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihyb3V0ZV9maWx0ZXIoJ0JNVF8xJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihyb3V0ZV9maWx0ZXIoJ0JNVF8yJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihyb3V0ZV9maWx0ZXIoJ1dTVF8xYScpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIocm91dGVfZmlsdGVyKCdXU1RfMWInKSApICksXHJcbiAgICBhbGVydHMucGlwZSggZmlsdGVyKHJvdXRlX2ZpbHRlcignV1NUXzJjJykgKSApLFxyXG4gICAgYWxlcnRzLnBpcGUoIGZpbHRlcihyb3V0ZV9maWx0ZXIoJ1dTVF8yZCcpICkgKSxcclxuICAgIGFsZXJ0cy5waXBlKCBmaWx0ZXIodHJpcF9maWx0ZXIoJ1c1MTInKSApICksXHJcbiAgICBhbGVydHMucGlwZSggZmlsdGVyKHRyaXBfZmlsdGVyKCdXNTc5JykgKSApXHJcbiAgKVxyXG59XHJcblxyXG5ndGZzLmdldEdURlNTY2hlbWEoKS50aGVuKHNjaGVtYSA9PiB7XHJcbiAgZmlsdGVyZWRfYWxlcnRzKHNjaGVtYSkuc3Vic2NyaWJlKHByaW50KTtcclxuICAvLyBmaWx0ZXJlZF9hbGVydHMoc2NoZW1hKS5waXBlKG1hcChhbGVydF9mb3JtYXR0ZXIpLCBtZXJnZUFsbCgpKS5zdWJzY3JpYmUocHJpbnQpO1xyXG59KVxyXG5cclxuLy8gcmV0dXJucyBhbiBPYnNlcnZhYmxlIHdoaWNoIGVtaXRzIGFuIGFsZXJ0IGZvcm1hdHRlZCBhcyBhbiBvYmplY3RcclxuZnVuY3Rpb24gYWxlcnRfZm9ybWF0dGVyKGVudGl0eSkge1xyXG4gIHJldHVybiBmcm9tKG5ldyBQcm9taXNlKCBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgIHRyeVxyXG4gICAge1xyXG4gICAgICB2YXIgZW50aXRpZXMgPSBlbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5Lm1hcChndGZzLmdldEVudGl0eU5hbWUpO1xyXG4gICAgICBQcm9taXNlLmFsbChlbnRpdGllcykudGhlbihlYSA9PiB7XHJcbiAgICAgICAgcmVzb2x2ZShcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgJ3RpdGxlJyA6IGVudGl0eS5hbGVydC5oZWFkZXJfdGV4dC50cmFuc2xhdGlvblswXS50ZXh0ICsgJyAoJyArXHJcbiAgICAgICAgICAgIGVhLmZpbHRlcigoZSxpLGEpID0+IGkgPT0gMCA/IHRydWUgOiAhYS5zbGljZSgwLGkpLmluY2x1ZGVzKGUpKVxyXG4gICAgICAgICAgICAucmVkdWNlKChhLHYsaSk9PmErKGk+MD8nLCAnOicnKSt2LCAnJykgKyAnKScgLFxyXG4gICAgICAgICAgICAnbWVzc2FnZScgOiBlbnRpdHkuYWxlcnQuZGVzY3JpcHRpb25fdGV4dC50cmFuc2xhdGlvblswXS50ZXh0LFxyXG4gICAgICAgICAgICAnbGluaycgIDogZW50aXR5LmFsZXJ0LnVybC50cmFuc2xhdGlvblswXS50ZXh0XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKVxyXG4gICAgICB9KVxyXG4gICAgfSBjYXRjaChlKSB7IHJlamVjdChlKSB9XHJcbiAgfSlcclxuICApXHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBlbnRpdHlfaWQoZW50aXR5KSB7XHJcbiAgaWYgKGVudGl0eS50cmlwKSB7XHJcbiAgICByZXR1cm4gZW50aXR5LnRyaXBcclxuICB9IGVsc2UgaWYgKGVudGl0eS5zdG9wX2lkICE9ICcnKSB7XHJcbiAgICByZXR1cm4gZW50aXR5LnN0b3BfaWRcclxuICB9IGVsc2UgaWYgKGVudGl0eS5yb3V0ZV9pZCAhPSAnJykge1xyXG4gICAgcmV0dXJuIGVudGl0eS5yb3V0ZV9pZFxyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gJ3Vua25vd24nXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzdG9wX2ZpbHRlcihpZCkge1xyXG4gIHJldHVybiAoZW50aXR5KSA9PiBlbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5Lm1hcChpPT5pLnN0b3BfaWQpLmluY2x1ZGVzKGlkKVxyXG59XHJcbmZ1bmN0aW9uIHJvdXRlX2ZpbHRlcihpZCkge1xyXG4gIHJldHVybiAoZW50aXR5KSA9PiBlbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5Lm1hcChpPT5pLnJvdXRlX2lkKS5pbmNsdWRlcyhpZClcclxufVxyXG5mdW5jdGlvbiB0cmlwX2ZpbHRlcihpZCkge1xyXG4gIHJldHVybiAoZW50aXR5KSA9PiBlbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5LnRyaXAgJiYgZW50aXR5LmFsZXJ0LmluZm9ybWVkX2VudGl0eS5tYXAoaT0+aS50cmlwLnRyaXBfaWQuc2xpY2UoMCwgdHJpcF9pZC5pbmRleE9mKCcuJyktMSkpLmluY2x1ZGVzKGlkKVxyXG59XHJcbiJdfQ==