"use strict";

const https = require('https');

const path = require('path');

const proto = require('pbf');

const protocomp = require('pbf/compile');

const protoschema = require('protocol-buffers-schema');

const request = require('request-promise-native');

const fs = require('fs');

const filter = require('through2-filter');

const {
  print,
  stringify
} = require('q-i');

const aws = require('aws-sdk');

const streambuf = require('stream-buffers');

const cloneable = require('cloneable-readable');

const csv_parser = require('csv-streamify');

function getGTFSSchema() {
  return new Promise((resolve, reject) => {
    fs.readFile('./gtfs-realtime.proto', (err, content) => {
      resolve(protocomp(protoschema.parse(content)));
    });
  });
  return new Promise(function (resolve, reject) {
    const s3 = new aws.S3();
    s3.getObject({
      Bucket: 'tfnsw-gtfs',
      Key: 'gtfs-realtime.proto'
    }).promise().then(res => {
      resolve(protocomp(protoschema.parse(res.Body.toString())));
    }).catch(reject);
  });
} // returns a Promise that resolves to an encoded GTFS FeedMessage


function getTrainsStatus() {
  return request('https://api.transport.nsw.gov.au/v1/gtfs/alerts/sydneytrains', {
    resolveWithFullResponse: true,
    encoding: null,
    headers: {
      Authorization: `apikey ${process.env.TFNSW_API_KEY}`
    }
  });
}

function parseGTFS(raw_resp) {
  return new proto(raw_resp);
}

; // gtfs: gtfs schema object
// gtfs_feedmessage: an encoded GTFS FeedMessage
// returns: an array of Promises resolving to entity detail object

function processFeedMessage(gtfs, gtfs_feedmessage) {
  const entities = [];
  gtfs.FeedMessage.read(gtfs_feedmessage).entity.forEach(e => entities.push(getEntity(e)));
  return entities;
}

function getEntityName(entity) {
  if (entity.trip) {
    return getTrip(entity.trip.trip_id);
  } else if (entity.stop_id != '') {
    return getStop(entity.stop_id);
  } else if (entity.route_id != '') {
    return getRoute(entity.route_id);
  }
}

function getEntity(gtfs_entity) {
  if (gtfs_entity.alert.informed_entity[0].trip) {
    return getTrip(gtfs_entity.alert.informed_entity[0].trip);
  } else if (gtfs_entity.alert.informed_entity[0].stop_id) {
    return getStop(gtfs_entity.alert.informed_entity[0].stop_id);
  } else if (gtfs_entity.alert.informed_entity[0].route_id) {
    return getRoute(gtfs_entity.alert.informed_entity[0].route_id);
  }
}

function getEntityFromDb(datafile, filter, callback) {
  const cachefile = path.format({
    dir: process.env.TEMP,
    name: datafile
  });
  const parser = csv_parser({
    columns: true,
    objectMode: true
  });
  return new Promise(function (resolve, reject) {
    fs.open(cachefile, (err, fd) => {
      if (!err) {
        // console.log(`cache hit for ${datafile} in ${cachefile}`);
        fs.createReadStream('', {
          fd: fd
        }).pipe(parser).pipe(filter);
      } else {
        console.log(`cacheing ${datafile} in ${cachefile}`);
        const s3 = new aws.S3();
        var db = s3.getObject({
          Bucket: 'tfnsw-gtfs',
          Key: datafile
        }).createReadStream();
        db.on('end', () => {
          console.log('s3 fetch done');
          fs.createReadStream(cachefile).pipe(filter);
        });
        db.pipe(fs.createWriteStream(cachefile));
      }

      filter.on('end', resolve);
    });
  });
}

function getRoute(route_id) {
  return new Promise((resolve, reject) => {
    getEntityFromDb("routes.txt", filter({
      objectMode: true
    }, function (chunk) {
      return chunk.route_id == route_id;
    })).then(route => resolve(route.route_short_name));
  });
}

function getTrip(trip_id) {
  return new Promise((resolve, reject) => {
    getEntityFromDb("trips.txt", filter({
      objectMode: true
    }, function (chunk) {
      return chunk.trip_id == trip_id;
    })).then(trip => resolve(trip.trip_headsign));
  });
}

function getStop(stop_id) {
  return new Promise((resolve, reject) => {
    getEntityFromDb("stops.txt", filter({
      objectMode: true
    }, function (chunk) {
      return chunk.stop_id == stop_id;
    })).then(stop => resolve(stop.stop_name));
  });
}

module.exports = {
  getGTFSSchema,
  getTrainsStatus,
  processFeedMessage,
  parseGTFS,
  getEntityName,
  getEntity
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ndGZzLmpzIl0sIm5hbWVzIjpbImh0dHBzIiwicmVxdWlyZSIsInBhdGgiLCJwcm90byIsInByb3RvY29tcCIsInByb3Rvc2NoZW1hIiwicmVxdWVzdCIsImZzIiwiZmlsdGVyIiwicHJpbnQiLCJzdHJpbmdpZnkiLCJhd3MiLCJzdHJlYW1idWYiLCJjbG9uZWFibGUiLCJjc3ZfcGFyc2VyIiwiZ2V0R1RGU1NjaGVtYSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicmVhZEZpbGUiLCJlcnIiLCJjb250ZW50IiwicGFyc2UiLCJzMyIsIlMzIiwiZ2V0T2JqZWN0IiwiQnVja2V0IiwiS2V5IiwicHJvbWlzZSIsInRoZW4iLCJyZXMiLCJCb2R5IiwidG9TdHJpbmciLCJjYXRjaCIsImdldFRyYWluc1N0YXR1cyIsInJlc29sdmVXaXRoRnVsbFJlc3BvbnNlIiwiZW5jb2RpbmciLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsInByb2Nlc3MiLCJlbnYiLCJURk5TV19BUElfS0VZIiwicGFyc2VHVEZTIiwicmF3X3Jlc3AiLCJwcm9jZXNzRmVlZE1lc3NhZ2UiLCJndGZzIiwiZ3Rmc19mZWVkbWVzc2FnZSIsImVudGl0aWVzIiwiRmVlZE1lc3NhZ2UiLCJyZWFkIiwiZW50aXR5IiwiZm9yRWFjaCIsImUiLCJwdXNoIiwiZ2V0RW50aXR5IiwiZ2V0RW50aXR5TmFtZSIsInRyaXAiLCJnZXRUcmlwIiwidHJpcF9pZCIsInN0b3BfaWQiLCJnZXRTdG9wIiwicm91dGVfaWQiLCJnZXRSb3V0ZSIsImd0ZnNfZW50aXR5IiwiYWxlcnQiLCJpbmZvcm1lZF9lbnRpdHkiLCJnZXRFbnRpdHlGcm9tRGIiLCJkYXRhZmlsZSIsImNhbGxiYWNrIiwiY2FjaGVmaWxlIiwiZm9ybWF0IiwiZGlyIiwiVEVNUCIsIm5hbWUiLCJwYXJzZXIiLCJjb2x1bW5zIiwib2JqZWN0TW9kZSIsIm9wZW4iLCJmZCIsImNyZWF0ZVJlYWRTdHJlYW0iLCJwaXBlIiwiY29uc29sZSIsImxvZyIsImRiIiwib24iLCJjcmVhdGVXcml0ZVN0cmVhbSIsImNodW5rIiwicm91dGUiLCJyb3V0ZV9zaG9ydF9uYW1lIiwidHJpcF9oZWFkc2lnbiIsInN0b3AiLCJzdG9wX25hbWUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRSxLQUFLLEdBQUdGLE9BQU8sQ0FBQyxLQUFELENBQXJCOztBQUNBLE1BQU1HLFNBQVMsR0FBR0gsT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBQ0EsTUFBTUksV0FBVyxHQUFHSixPQUFPLENBQUMseUJBQUQsQ0FBM0I7O0FBQ0EsTUFBTUssT0FBTyxHQUFHTCxPQUFPLENBQUMsd0JBQUQsQ0FBdkI7O0FBQ0EsTUFBTU0sRUFBRSxHQUFHTixPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNTyxNQUFNLEdBQUdQLE9BQU8sQ0FBQyxpQkFBRCxDQUF0Qjs7QUFDQSxNQUFNO0FBQUVRLEVBQUFBLEtBQUY7QUFBU0MsRUFBQUE7QUFBVCxJQUF1QlQsT0FBTyxDQUFDLEtBQUQsQ0FBcEM7O0FBQ0EsTUFBTVUsR0FBRyxHQUFHVixPQUFPLENBQUMsU0FBRCxDQUFuQjs7QUFDQSxNQUFNVyxTQUFTLEdBQUdYLE9BQU8sQ0FBQyxnQkFBRCxDQUF6Qjs7QUFDQSxNQUFNWSxTQUFTLEdBQUdaLE9BQU8sQ0FBQyxvQkFBRCxDQUF6Qjs7QUFDQSxNQUFNYSxVQUFVLEdBQUdiLE9BQU8sQ0FBQyxlQUFELENBQTFCOztBQUVBLFNBQVNjLGFBQVQsR0FBeUI7QUFDdkIsU0FBTyxJQUFJQyxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDWCxJQUFBQSxFQUFFLENBQUNZLFFBQUgsQ0FBWSx1QkFBWixFQUFxQyxDQUFDQyxHQUFELEVBQU1DLE9BQU4sS0FB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V0FEYyxFQUVkMUQsTUFBTSxDQUFDO0FBQUVvRSxNQUFBQSxVQUFVLEVBQUc7QUFBZixLQUFELEVBQXdCLFVBQVNVLEtBQVQsRUFBZ0I7QUFBRSxhQUFPQSxLQUFLLENBQUM1QixPQUFOLElBQWlCQSxPQUF4QjtBQUFpQyxLQUEzRSxDQUZRLENBQWYsQ0FJRTdCLElBSkYsQ0FJUTJCLElBQUQsSUFBVXZDLE9BQU8sQ0FBQ3VDLElBQUksQ0FBQ2lDLGFBQU4sQ0FKeEI7QUFLQyxHQU5LLENBQVA7QUFPQTs7QUFFRCxTQUFTN0IsT0FBVCxDQUFpQkQsT0FBakIsRUFBMEI7QUFDekIsU0FBTyxJQUFJM0MsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN2Q2dELElBQUFBLGVBQWUsQ0FDZCxXQURjLEVBRWQxRCxNQUFNLENBQUM7QUFBRW9FLE1BQUFBLFVBQVUsRUFBRztBQUFmLEtBQUQsRUFBd0IsVUFBU1UsS0FBVCxFQUFnQjtBQUFFLGFBQU9BLEtBQUssQ0FBQzNCLE9BQU4sSUFBaUJBLE9BQXhCO0FBQWlDLEtBQTNFLENBRlEsQ0FBZixDQUlFOUIsSUFKRixDQUlRNkQsSUFBRCxJQUFVekUsT0FBTyxDQUFDeUUsSUFBSSxDQUFDQyxTQUFOLENBSnhCO0FBS0MsR0FOSyxDQUFQO0FBT0E7O0FBQ0RDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUFFOUUsRUFBQUEsYUFBRjtBQUFpQm1CLEVBQUFBLGVBQWpCO0FBQWtDVSxFQUFBQSxrQkFBbEM7QUFBc0RGLEVBQUFBLFNBQXREO0FBQWlFYSxFQUFBQSxhQUFqRTtBQUFnRkQsRUFBQUE7QUFBaEYsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IHByb3RvID0gcmVxdWlyZSgncGJmJyk7XHJcbmNvbnN0IHByb3RvY29tcCA9IHJlcXVpcmUoJ3BiZi9jb21waWxlJyk7XHJcbmNvbnN0IHByb3Rvc2NoZW1hID0gcmVxdWlyZSgncHJvdG9jb2wtYnVmZmVycy1zY2hlbWEnKTtcclxuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZS1uYXRpdmUnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5jb25zdCBmaWx0ZXIgPSByZXF1aXJlKCd0aHJvdWdoMi1maWx0ZXInKTtcclxuY29uc3QgeyBwcmludCwgc3RyaW5naWZ5IH0gPSByZXF1aXJlKCdxLWknKTtcclxuY29uc3QgYXdzID0gcmVxdWlyZSgnYXdzLXNkaycpO1xyXG5jb25zdCBzdHJlYW1idWYgPSByZXF1aXJlKCdzdHJlYW0tYnVmZmVycycpO1xyXG5jb25zdCBjbG9uZWFibGUgPSByZXF1aXJlKCdjbG9uZWFibGUtcmVhZGFibGUnKTtcclxuY29uc3QgY3N2X3BhcnNlciA9IHJlcXVpcmUoJ2Nzdi1zdHJlYW1pZnknKTtcclxuXHJcbmZ1bmN0aW9uIGdldEdURlNTY2hlbWEoKSB7XHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGZzLnJlYWRGaWxlKCcuL2d0ZnMtcmVhbHRpbWUucHJvdG8nLCAoZXJyLCBjb250ZW50KSA9PiB7IHJlc29sdmUocHJvdG9jb21wKHByb3Rvc2NoZW1hLnBhcnNlKGNvbnRlbnQpKSkgfSlcclxuICB9KTtcclxuXHJcblx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xyXG5cdFx0Y29uc3QgczMgPSBuZXcgYXdzLlMzKCk7XHJcblx0XHRzMy5nZXRPYmplY3Qoe0J1Y2tldDondGZuc3ctZ3RmcycsS2V5OidndGZzLXJlYWx0aW1lLnByb3RvJ30pLnByb21pc2UoKVxyXG5cdFx0XHQudGhlbiggcmVzID0+IHsgcmVzb2x2ZShwcm90b2NvbXAocHJvdG9zY2hlbWEucGFyc2UocmVzLkJvZHkudG9TdHJpbmcoKSkpKSB9KVxyXG5cdFx0XHQuY2F0Y2goIHJlamVjdCApO1xyXG5cdH0pO1xyXG59XHJcblxyXG4vLyByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIGFuIGVuY29kZWQgR1RGUyBGZWVkTWVzc2FnZVxyXG5mdW5jdGlvbiBnZXRUcmFpbnNTdGF0dXMoKSB7XHJcblx0XHRyZXR1cm4gcmVxdWVzdChcclxuXHRcdFx0J2h0dHBzOi8vYXBpLnRyYW5zcG9ydC5uc3cuZ292LmF1L3YxL2d0ZnMvYWxlcnRzL3N5ZG5leXRyYWlucycsXHJcblx0XHRcdHsgXHJcblx0XHRcdFx0cmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UgOiB0cnVlLFxyXG5cdFx0XHRcdGVuY29kaW5nIDogbnVsbCxcclxuXHRcdFx0XHRoZWFkZXJzIDogeyBBdXRob3JpemF0aW9uIDogYGFwaWtleSAke3Byb2Nlc3MuZW52LlRGTlNXX0FQSV9LRVl9YCB9IFxyXG5cdFx0XHR9XHJcblx0XHQpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlR1RGUyhyYXdfcmVzcCkge1xyXG5cdHJldHVybiBuZXcgcHJvdG8ocmF3X3Jlc3ApO1xyXG59O1xyXG5cclxuLy8gZ3RmczogZ3RmcyBzY2hlbWEgb2JqZWN0XHJcbi8vIGd0ZnNfZmVlZG1lc3NhZ2U6IGFuIGVuY29kZWQgR1RGUyBGZWVkTWVzc2FnZVxyXG4vLyByZXR1cm5zOiBhbiBhcnJheSBvZiBQcm9taXNlcyByZXNvbHZpbmcgdG8gZW50aXR5IGRldGFpbCBvYmplY3RcclxuZnVuY3Rpb24gcHJvY2Vzc0ZlZWRNZXNzYWdlKGd0ZnMsIGd0ZnNfZmVlZG1lc3NhZ2UpIHtcclxuXHRjb25zdCBlbnRpdGllcyA9IFtdO1xyXG5cdGd0ZnMuRmVlZE1lc3NhZ2UucmVhZChndGZzX2ZlZWRtZXNzYWdlKS5lbnRpdHkuZm9yRWFjaChlPT5lbnRpdGllcy5wdXNoKGdldEVudGl0eShlKSkpO1xyXG5cdHJldHVybiBlbnRpdGllcztcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RW50aXR5TmFtZShlbnRpdHkpIHtcclxuXHRpZiAoZW50aXR5LnRyaXApIHtcclxuXHRcdHJldHVybiBnZXRUcmlwKGVudGl0eS50cmlwLnRyaXBfaWQpXHJcblx0fSBlbHNlIGlmIChlbnRpdHkuc3RvcF9pZCAhPSAnJykge1xyXG5cdFx0cmV0dXJuIGdldFN0b3AoZW50aXR5LnN0b3BfaWQpXHJcblx0fSBlbHNlIGlmIChlbnRpdHkucm91dGVfaWQgIT0gJycpIHtcclxuXHRcdHJldHVybiBnZXRSb3V0ZShlbnRpdHkucm91dGVfaWQpXHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFbnRpdHkoZ3Rmc19lbnRpdHkpIHtcclxuXHRpZiAoZ3Rmc19lbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5WzBdLnRyaXApIHtcclxuXHRcdHJldHVybiBnZXRUcmlwKGd0ZnNfZW50aXR5LmFsZXJ0LmluZm9ybWVkX2VudGl0eVswXS50cmlwKVxyXG5cdH0gZWxzZSBpZiAoZ3Rmc19lbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5WzBdLnN0b3BfaWQpIHtcclxuXHRcdHJldHVybiBnZXRTdG9wKGd0ZnNfZW50aXR5LmFsZXJ0LmluZm9ybWVkX2VudGl0eVswXS5zdG9wX2lkKVxyXG5cdH0gZWxzZSBpZiAoZ3Rmc19lbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5WzBdLnJvdXRlX2lkKSB7XHJcblx0XHRyZXR1cm4gZ2V0Um91dGUoZ3Rmc19lbnRpdHkuYWxlcnQuaW5mb3JtZWRfZW50aXR5WzBdLnJvdXRlX2lkKVxyXG5cdH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RW50aXR5RnJvbURiKGRhdGFmaWxlLCBmaWx0ZXIsIGNhbGxiYWNrKSB7XHJcbiAgY29uc3QgY2FjaGVmaWxlID0gcGF0aC5mb3JtYXQoe2RpcjogcHJvY2Vzcy5lbnYuVEVNUCwgbmFtZTogZGF0YWZpbGV9KTtcclxuICBjb25zdCBwYXJzZXIgPSBjc3ZfcGFyc2VyKHsgY29sdW1ucyA6IHRydWUsIG9iamVjdE1vZGUgOiB0cnVlIH0pO1xyXG5cclxuICByZXR1cm4gbmV3IFByb21pc2UoIGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xyXG5cdFx0ZnMub3BlbihjYWNoZWZpbGUsIChlcnIsIGZkKSA9PiB7XHJcblx0XHRcdGlmICghZXJyKSB7XHJcblx0XHRcdFx0Ly8gY29uc29sZS5sb2coYGNhY2hlIGhpdCBmb3IgJHtkYXRhZmlsZX0gaW4gJHtjYWNoZWZpbGV9YCk7XHJcblx0XHRcdFx0ZnMuY3JlYXRlUmVhZFN0cmVhbSgnJywgeyBmZDogZmQgfSkucGlwZShwYXJzZXIpLnBpcGUoZmlsdGVyKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRjb25zb2xlLmxvZyhgY2FjaGVpbmcgJHtkYXRhZmlsZX0gaW4gJHtjYWNoZWZpbGV9YCk7XHJcblx0XHRcdFx0Y29uc3QgczMgPSBuZXcgYXdzLlMzKCk7XHJcblx0XHRcdFx0dmFyIGRiID0gczMuZ2V0T2JqZWN0KHtCdWNrZXQ6J3RmbnN3LWd0ZnMnLEtleTpkYXRhZmlsZX0pLmNyZWF0ZVJlYWRTdHJlYW0oKTtcclxuXHRcdFx0XHRkYi5vbignZW5kJywgKCkgPT4geyBjb25zb2xlLmxvZygnczMgZmV0Y2ggZG9uZScpOyBmcy5jcmVhdGVSZWFkU3RyZWFtKGNhY2hlZmlsZSkucGlwZShmaWx0ZXIpIH0pXHJcblx0XHRcdFx0ZGIucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbShjYWNoZWZpbGUpKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRmaWx0ZXIub24oJ2VuZCcsIHJlc29sdmUpO1xyXG5cdFx0fSlcclxuXHR9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRSb3V0ZShyb3V0ZV9pZCkge1xyXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcblx0XHRnZXRFbnRpdHlGcm9tRGIoXHJcblx0XHRcdFwicm91dGVzLnR4dFwiLCBcclxuXHRcdFx0ZmlsdGVyKHsgb2JqZWN0TW9kZSA6IHRydWUgfSwgZnVuY3Rpb24oY2h1bmspIHsgcmV0dXJuIGNodW5rLnJvdXRlX2lkID09IHJvdXRlX2lkIH0pXHJcblx0XHQpXHJcblx0XHRcdC50aGVuKChyb3V0ZSkgPT4gcmVzb2x2ZShyb3V0ZS5yb3V0ZV9zaG9ydF9uYW1lKSlcclxuXHRcdH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFRyaXAodHJpcF9pZCkge1xyXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcblx0XHRnZXRFbnRpdHlGcm9tRGIoXHJcblx0XHRcdFwidHJpcHMudHh0XCIsIFxyXG5cdFx0XHRmaWx0ZXIoeyBvYmplY3RNb2RlIDogdHJ1ZSB9LCBmdW5jdGlvbihjaHVuaykgeyByZXR1cm4gY2h1bmsudHJpcF9pZCA9PSB0cmlwX2lkIH0pXHJcblx0XHQpXHJcblx0XHRcdC50aGVuKCh0cmlwKSA9PiByZXNvbHZlKHRyaXAudHJpcF9oZWFkc2lnbikpXHJcblx0XHR9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRTdG9wKHN0b3BfaWQpIHtcclxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG5cdFx0Z2V0RW50aXR5RnJvbURiKFxyXG5cdFx0XHRcInN0b3BzLnR4dFwiLCBcclxuXHRcdFx0ZmlsdGVyKHsgb2JqZWN0TW9kZSA6IHRydWUgfSwgZnVuY3Rpb24oY2h1bmspIHsgcmV0dXJuIGNodW5rLnN0b3BfaWQgPT0gc3RvcF9pZCB9KVxyXG5cdFx0KVxyXG5cdFx0XHQudGhlbigoc3RvcCkgPT4gcmVzb2x2ZShzdG9wLnN0b3BfbmFtZSkpXHJcblx0XHR9KVxyXG59XHJcbm1vZHVsZS5leHBvcnRzID0geyBnZXRHVEZTU2NoZW1hLCBnZXRUcmFpbnNTdGF0dXMsIHByb2Nlc3NGZWVkTWVzc2FnZSwgcGFyc2VHVEZTLCBnZXRFbnRpdHlOYW1lLCBnZXRFbnRpdHkgfVxyXG4iXX0=