// https://issues.jenkins-ci.org/browse/JENKINS-43911
node('master') {
	stage('Get AWS credentials into environment') {
		environment { AWS_KEY = credentials('AWS-jenkins-user') }
	}
}
pipeline {
	agent none
	parameters { 
		string(name: 'Environment', defaultValue: 'dev', description: 'target environment name')
	}

	stages {
		stage('build') {
			agent {
				docker {
					image 'node:10-alpine'
					args '-p 3000:3000'
				}
			}
			steps {
				dir('formatAlertForPush') {
					sh 'npm install'
				} 
			}
		}
		stage('deploy') {
			agent {
				dockerfile {
					dir 'deploy-container'
					args "-e AWS_ACCESS_KEY_ID=${AWS_KEY_USR} -e AWS_SECRET_ACCESS_KEY=${AWS_KEY_PSW} -e AWS_DEFAULT_REGION=ap-southeast-2"
				}
			}
			steps {
				dir('formatAlertForPush') {
					sh "echo ${ENVTHING}"
					sh 'zip add formatAlertForPush.zip *.json *.js node_modules/*'

				}
			}
		}
	}
}
